      SUBROUTINE RCA06
! 
!     RCA06 READS PARAMS, CONST, MISC TIME FUNCTIONS AND MISC FILE NAMES
! 
      USE ALL_VARS, ONLY : MSR,SERIAL,MYID
      USE MOD_RCA
      IMPLICIT NONE
      SAVE
!      INCLUDE  'RCACM'
      CHARACTER  PNAME*20,CNAME(MXCONS)*10,COMMENT*80
      REAL   PSCAL(30)
      INTEGER IBNRYRDOPT,NOPAM,NOBRK,IUNITCHECK,NOKINFILNA
      INTEGER I,J,JL,JM

!     P A R A M E T E R S 
print*,'rca06 16 ',MYID
      IF(MSR) WRITE(OUT,'(/////1X,119("*")//)')
      TWARPTVF='SECS'

      READ(IN,'(A)')  COMMENT
      READ(IN,'(A40,I10)')  PCFILNA,IBNRYRDOPT
      IF(PCFILNA == 'NULL') THEN
       IF(MSR) WRITE(OUT,'(///30X,"USER SPECIFIES THAT THERE IS NO PC FILE TO BE READ")')
       GO TO 450
      ENDIF
      IF(MSR) WRITE(OUT,'(10X,"OPENING PCFILNA = ",A40//)') PCFILNA
      IF(IBNRYRDOPT == 0) THEN
        OPEN(37,FILE=PCFILNA,FORM='FORMATTED')
      ELSE
        OPEN(37,FILE=PCFILNA,FORM='UNFORMATTED')
      ENDIF

!     DEPTH INDEPENDENT (2-D)

      IF(IBNRYRDOPT == 0) THEN
       READ(37,'(A)') COMMENT
       READ(37,'(2I10)',ERR=950) NOPAM 
      ELSE
       READ(37) NOPAM 
      ENDIF
      IF(NOPAM > MXPARM2D) GO TO 960
      IF(NOPAM == 0) GO TO 120
      IF(IBNRYRDOPT == 0) THEN
       READ(37,'(A)') COMMENT
       READ(37,'(8F10.0)',ERR=950)    (PSCAL(I),I=1,NOPAM) 
      ELSE
       READ(37)    (PSCAL(I),I=1,NOPAM) 
      ENDIF
      IF(MSR) WRITE(OUT,1002)    (PSCAL(I),I=1,NOPAM) 
 1002 FORMAT(//51X,'LAYER INDEPENDENT (2-D) PARAMETERS'                    &
         //8X,'SCALE'/6X,'FACTORS',5(6X,E14.5)/13X,5(6X,E14.5))
      DO I=1,NOPAM
       IF(IBNRYRDOPT == 0) THEN
        READ(37,'(A20)',ERR=950)   PNAME
       ELSE
        READ(37)   PNAME
       ENDIF
       IF(MSR) WRITE(OUT,'(//20X,A20)')   PNAME

       IF(IBNRYRDOPT == 0) THEN
        READ(37,'(8F10.0)',ERR=950)   (PARAM2D_GL(IXY,I),IXY=1,NXY)
       ELSE
        READ(37)   (PARAM2D_GL(IXY,I),IXY=1,NXY)
       ENDIF
       IF(LIST(4) == 1) THEN
        IF(MSR) WRITE(OUT,'(10X,"COL",43X,"ROW"/25X,"2",15X,"3",14X,"..."/)') 
        IF(MSR) WRITE(OUT,1202)   (PARAM2D_GL(IXY,I),IXY=1,NXY)
 1202   FORMAT(10X,5X,8(2X,E13.5)/15X,8(2X,E13.5)/15X,8(2X,E13.5))
       ENDIF
!      INCORPORATE SCALE FACTOR
       DO IXY=1,NXY
        PARAM2D_GL(IXY,I) = PARAM2D_GL(IXY,I)*PSCAL(I) 
       END DO
      END DO
      
      IF(SERIAL) PARAM2D = PARAM2D_GL

!     DEPTH DEPENDENT (3-D)

  120 IF(IBNRYRDOPT == 0) THEN
       READ(37,'(A)') COMMENT
       READ(37,'(2I10)',ERR=950) NOPAM 
      ELSE
       READ(37) NOPAM 
      ENDIF
      IF(NOPAM > MXPARM3D) GO TO 962
      IF(NOPAM == 0) GO TO 220
      IF(IBNRYRDOPT == 0) THEN
       READ(37,'(A)') COMMENT
       READ(37,'(8F10.0)',ERR=950)    (PSCAL(I),I=1,NOPAM) 
      ELSE
       READ(37)    (PSCAL(I),I=1,NOPAM) 
      ENDIF
      IF(MSR) WRITE(OUT,1003)    (PSCAL(I),I=1,NOPAM) 
 1003 FORMAT(//51X,'LAYER DEPENDENT (3-D) PARAMETERS'                    &
         //8X,'SCALE'/6X,'FACTORS',5(6X,E14.5)/13X,5(6X,E14.5))
      DO I=1,NOPAM
       IF(IBNRYRDOPT == 0) THEN
        READ(37,'(A20)',ERR=950) PNAME
       ELSE
        READ(37) PNAME
       ENDIF
       IF(MSR) WRITE(OUT,'(//20X,A20)')   PNAME
       DO IZ=1,NZ
        IF(IBNRYRDOPT == 0) THEN
         READ(37,'(8F10.0)',ERR=950)   (PARAM3D_GL(IXY,IZ,I),IXY=1,NXY)
        ELSE
         READ(37)   (PARAM3D_GL(IXY,IZ,I),IXY=1,NXY)
        ENDIF
        IF(LIST(4) == 1) THEN
         IF(MSR) WRITE(OUT,'(4X,"LAYER COL",43X,"ROW"/25X,"2",15X,"3",14X,"..."/)')
         IF(MSR) WRITE(OUT,1203)   IZ,(PARAM3D_GL(IXY,IZ,I),IXY=1,NXY)
 1203    FORMAT(6X,I2,2X,1X,8(2X,E13.5)/15X,8(2X,E13.5)/                 &
           15X,8(2X,E13.5)/15X,8(2X,E13.5)/15X,8(2X,E13.5)/              &
           15X,8(2X,E13.5)/15X,8(2X,E13.5)/15X,8(2X,E13.5))
        ENDIF
!       INCORPORATE SCALE FACTOR
        DO IXY=1,NXY
          PARAM3D_GL(IXY,IZ,I) = PARAM3D_GL(IXY,IZ,I)*PSCAL(I) 
        END DO
       END DO
      END DO

!     C O N S T A N T S 

  220 IF(IBNRYRDOPT == 0) THEN
       READ(37,'(A)') COMMENT
       READ(37,'(2I10)',ERR=950)   NOCONS 
      ELSE
       READ(37)   NOCONS 
      ENDIF
      IF(NOCONS > MXCONS) GO TO 964
      IF(NOCONS == 0) GO TO 250
      IF(IBNRYRDOPT == 0) THEN
       DO I=1,NOCONS,8
        JL=I
        JM=MIN(I+7,NOCONS)
        READ(37,'(8A10)',ERR=950)   (CNAME(J),J=JL,JM)
        READ(37,'(8F10.0)',ERR=950)   (CONST(J),J=JL,JM)
       ENDDO
      ELSE
       READ(37)   (CNAME(I),CONST(I),I=1,NOCONS)
      ENDIF
      IF(LIST(4) == 1) THEN
       IF(MSR) WRITE(OUT,1400)   (CNAME(I),CONST(I),I=1,NOCONS)
 1400  FORMAT(//55X,'CONSTANTS'//8X,4(2X,A10,'=',E13.5)/                  &
             (10X,A10,'=',E13.5,2X,A10,'=',E13.5,2X,A10,'=',E13.5,2X,     &
              A10,'=',E13.5)) 
      ENDIF

!     M I S C   T I M E   F U N C T I O N S

  250 IF(IBNRYRDOPT == 0) THEN
       READ(37,'(A)') COMMENT
       READ(37,'(2I10)',ERR=950)  NOFUNC,ITVFPWLOPT
      ELSE
       READ(37)  NOFUNC,ITVFPWLOPT
      ENDIF
      IF(NOFUNC > MXFUNC) GO TO 966
      IF(NOFUNC == 0) GO TO 350
      IF(MSR) WRITE(OUT,1600)
 1600 FORMAT(//45X,'MODEL DEPENDENT TIME FUNCTIONS')
      IF(ITVFPWLOPT == 0) THEN
       IF(MSR) WRITE(OUT,1610)
 1610  FORMAT(/37X,'THE USER SELECTED STEP FUNCTION INTERPOLATION')
      ELSE
       IF(MSR) WRITE(OUT,1620)
 1620  FORMAT(/35X,'THE USER SELECTED PIECEWISE LINEAR INTERPOLATION')
      ENDIF
      IF(MSR) WRITE(OUT,1650) 
 1650 FORMAT(/6X,5(7X,'VAL(T)',6X,'T',2X)/) 
      NXCALL13T=999.
      DO 300 I=1,NOFUNC
       IF(IBNRYRDOPT == 0) THEN
        READ(37,'(A)') COMMENT
        READ(37,1700,ERR=950)   PNAME,NOBRK,TWARPTVF
 1700   FORMAT(A10,I10,6X,A4)
        IF(NOBRK > MXFUNCT) GO TO 968
         READ(37,'(8F10.0)',ERR=950) (VALMTF(I,J),TIMEMTF(I,J),J=1,NOBRK)
        ELSE
         READ(37)   PNAME,NOBRK,TWARPTVF
         IF(NOBRK > MXFUNCT) GO TO 968
         READ(37)   (VALMTF(I,J),TIMEMTF(I,J),J=1,NOBRK)
        ENDIF
        ISCALTVF=IUNITCHECK(TWARPTVF,'TWARPTVF')
!       DO J=1,NOBRK
!        TVAL(J)=ISCALTVF*TVAL(J)
!       ENDDO
        IF(LIST(4) == 1) THEN
         IF(MSR) WRITE(OUT,2000) PNAME,(VALMTF(I,J),TIMEMTF(I,J),J=1,NOBRK)
 2000    FORMAT(1X,A10,5(E15.5,F7.2)/(6X,E15.5,F7.2,E15.5,F7.2             &
                ,E15.5,F7.2,E15.5,F7.2,E15.5,F7.2)) 
        ENDIF
        IF(ITVFPWLOPT == 0) THEN
         MFUNC(I)=0.
         BFUNC(I)=VALMTF(I,1) 
        ELSE
         MFUNC(I)=(VALMTF(I,2)-VALMTF(I,1))/(TIMEMTF(I,2)-TIMEMTF(I,1))
         BFUNC(I)=VALMTF(I,2)
        ENDIF
        NXFUNT(I) = TIMEMTF(I,2)
        ITIMF(I) = 2
        IF(NXFUNT(I) < NXCALL13T)  NXCALL13T = NXFUNT(I)
  300  CONTINUE

  350  READ(37,'(A)') COMMENT
       READ(37,'(2I10)',ERR=950)  NOKINFILNA
       IF(NOKINFILNA > MXKINFILES) GO TO 970
       IF(NOKINFILNA == 0) GO TO 450
       IF(MSR) WRITE(OUT,2100)  NOKINFILNA
 2100  FORMAT(//28X,'THE FOLLOWING',I3,' FILES WILL BE UTILIZED BY THE KINETIC SUBR')
       DO 375 I=1,NOKINFILNA
        READ(37,'(A40,I10)',ERR=950)  KINFILNA(I)
        IF(MSR) WRITE(OUT,'(10X,A40)')  KINFILNA(I)
  375  CONTINUE
  
  450  RETURN

  950  IN=37
       CALL FMTER
!       CALL EXIT 
       CALL PSTOP('rca06_222 ') 
  960  IF(MSR) WRITE(OUT,9600)  
 9600  FORMAT(//11X,'ERROR...USER REQUESTING MORE 2-D PARAMETERS THAN ',   &
             'DIMENSIONED FOR IN -RCACM-'/11X,'RCA TERMINATED'//)
!       CALL EXIT 
       CALL PSTOP('rca06_227 ')
  962  IF(MSR) WRITE(OUT,9602)  
 9602  FORMAT(//11X,'ERROR...USER REQUESTING MORE 3-D PARAMETERS THAN ',   &
             'DIMENSIONED FOR IN -RCACM-'/11X,'RCA TERMINATED'//)
!       CALL EXIT 
       CALL PSTOP('rca06_232 ')
  964  IF(MSR) WRITE(OUT,9604)  
 9604  FORMAT(//11X,'ERROR...USER REQUESTING MORE CONSTANTS THAN ',        &
             'DIMENSIONED FOR IN -RCACM-'/11X,'RCA TERMINATED'//)
!       CALL EXIT 
       CALL PSTOP('rca06_237 ')
  966  IF(MSR) WRITE(OUT,9606)  
 9606  FORMAT(//11X,'ERROR...USER REQUESTING MORE TIME FUNCTIONS THAN ',   &
             'DIMENSIONED FOR IN -RCACM-'/11X,'RCA TERMINATED'//)
!       CALL EXIT 
       CALL PSTOP('rca06_242 ')
  968  IF(MSR) WRITE(OUT,9608)  
 9608  FORMAT(//11X,'ERROR...USER REQUESTING MORE TIME BREAKS THAN ',      &
             'DIMENSIONED FOR IN -RCACM-'/11X,'RCA TERMINATED'//)
!       CALL EXIT 
       CALL PSTOP 
  970  IF(MSR) WRITE(OUT,9610)  
 9610  FORMAT(//11X,'ERROR...USER REQUESTING MORE KINETIC INPUT FILE NAMES', &
             ' THAN DIMENSIONED FOR IN -RCACM-'/11X,'RCA TERMINATED'//)
!       CALL EXIT 
       CALL PSTOP('rca06_252 ')
      END SUBROUTINE RCA06
      
      SUBROUTINE GLOB2LOC06
      USE ALL_VARS,ONLY : M,MT,PAR
      USE MOD_RCA,ONLY : PARAM2D,PARAM3D,MXPARM2D,MXPARM3D,IXY,IZ,NZ,   &
                         PARAM2D_GL,PARAM3D_GL
# if defined (MULTIPROCESSOR)
      USE MOD_PAR
# endif
      IMPLICIT NONE
      INTEGER :: I
      REAL,ALLOCATABLE :: TEMP1(:,:),TEMP2(:,:,:)
      
# if defined (MULTIPROCESSOR)

      IF(PAR)THEN
       ALLOCATE(TEMP1(MT,MXPARM2D))    ;TEMP1 = 0.0
       ALLOCATE(TEMP2(MT,NZ,MXPARM3D)) ;TEMP2 = 0.0
      
       DO I=1,MXPARM2D
        DO IXY=1,M
         TEMP1(IXY,I) = PARAM2D_GL(NGID(IXY),I) 
        END DO
        DO IXY=1,NHN
	 TEMP1(IXY+M,I) =  PARAM2D_GL(HN_LST(IXY),I)
        END DO
       END DO	

       DO I=1,MXPARM3D
        DO IZ=1,NZ
	 DO IXY=1,M
          TEMP2(IXY,IZ,I) = PARAM3D_GL(NGID(IXY),IZ,I) 
	 END DO 
	 DO IXY=1,NHN
          TEMP2(IXY+M,IZ,I) = PARAM3D_GL(HN_LST(IXY),IZ,I) 
         END DO
	END DO
       END DO	 

!JQI       DEALLOCATE(PARAM2D,PARAM3D)
       
!JQI       ALLOCATE(PARAM2D(MT,MXPARM2D))     ;PARAM2D = 0.0
!JQI       ALLOCATE(PARAM3D(MT,NZ,MXPARM3D)) ;PARAM3D = 0.0
       
       PARAM2D(1:MT,:) = TEMP1(1:MT,:)
       PARAM3D(1:MT,1:NZ,:) = TEMP2(1:MT,1:NZ,:)
       
       DEALLOCATE(TEMP1,TEMP2)
      END IF
# endif
      RETURN
      END SUBROUTINE GLOB2LOC06
      
