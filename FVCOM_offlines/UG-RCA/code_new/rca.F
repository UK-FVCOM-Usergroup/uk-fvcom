!     PROGRAM UG-RCA
! 
! 
!*******************************************************************************
! 
! 
!            UG-RCA  -  UNSTRUCUTRED GRID ROW/COLUMN VERSION OF AESOP 
!
!                                                  (RELEASE 3.0)
! 
!            DEVELOPED BY: UNIVERSITY OF MASSACHUSETTS-DARTMOUTH
!                          WITH PERMISSION FROM HYDROQUAL INC. MAHWAH, N.J.
!                          ON CONVERTING STRUCTURED GRID RCA TO UNSTRUCTURED GRID 
!                          FINITE-VOLUME VERSION.
!                           
!            UMASSD TEAM: CHANGSHENG CHEN, JIANHUA QI AND RUSHENG TIAN
!           
!            THE STRUCTURED GRID RCA (RELEASE 3.0) ARE PROGRAMED BY 
!                          JAMES FITZPATRICK AND  KAI-YUAN YANG 
!                          HYDROUAL INC.
!*******************************************************************************
! 
!*       Copyright (C) 2009, University of Massaschusetts-Dartmouth and HydroQual Inc.                       
!*                                                                        
!* 
!*       UG-RCA are coded by converting finit-difference discrete algorithms in RCA into the
!*       the unstructured grid finite-volume methods under the FVCOM framwork. The MPI is 
!*       implemented for parallelization. As the same as RCA, this code also contain unpublished
!*       proprietary information of FVCOM, and are protected by Federal copyright law. 
!*       
!*       HydroQual, INc has a copright of The structured grid RCA and are  protected by Federal 
!*       copyright law.  No part of this program and/or modifications of this program may 
!*       be reproduced in any form by print photocopy, microfilm, magnetic- or optical-media 
!*       or by any other  means, without written permission of HydroQual, Inc.
!*	 Authors: James Fitzpatrick
!*               Dominic DiToro
!*               Kai-Yuan Yang
!*               HydroQual, Inc.
!*               1200 Mac Arthur Blvd.
!*               Mahwah, NJ  07430
!*               USA
! 
!*******************************************************************************
! 
! 
!        THE FOLLOWING VARIABLES MUST BE DEFINED FOR EACH SITE SPECIFIC
!        WATER QUALITY MODEL VIA THE INCLUDE BLOCK -RCACM-
!
!     NX          -  NUMBER OF CELLS IN THE X-DIRECTION IN THE MODEL DOMAIN
!     NY          -  NUMBER OF CELLS IN THE Y-DIRECTION IN THE MODEL DOMAIN
!     NZ          -  NUMBER OF DEPTH LAYERS IN THE MODEL DOMAIN
!     NOSYS       -  NUMBER OF SYSTEMS OR WATER QUALITY VARIABLES
!                     IN THE MODEL
!
!        THE FOLLOWING VARIABLES SPECIFY THE MAXIMUM DIMENSIONS FOR
!        KEY MODEL VARIABLES
!     MXHYDFILES  -  MAXIMUM NUMBER OF LINKED HYDRODYNAMIC FILES
!     MXBC        -  MAXIMUM NUMBER OF BOUNDARY CONDITIONS PER SYSTEM
!     MXWK        -  MAXIMUM NUMBER OF FORCING FUNCTIONS OR LOADS
!     MXPARM2D    -  MAXIMUM NUMBER OF DEPTH-INDEPENDENT PARAMETERS
!     MXPARM3D    -  MAXIMUM NUMBER OF DEPTH-DEPENDENT PARAMETERS
!     MXCONS      -  MAXIMUM NUMBER OF CONSTANTS 
!     MXFUNC      -  MAXIMUM NUMBER OF MISCELLANEOUS TIME FUNCTIONS 
!     MXFUNCT     -  MAXIMUM NUMBER OF TIME BREAKS FOR THE
!                    MISCELLANEOUS TIME FUNCTIONS
!
!
!        DESCRIPTION OF COMMON VARIABLES
! 
!     IN          -  INPUT DEVICE NUMBER 
!     OUT         -  OUTPUT DEVICE NUMBER
!     MXACTS      -  NUMBER OF THE MAXIMUM (OR LAST) ACTIVE SYSTEM
!     ISYS        -  SYSTEM CURRENTLY HAVING ITS DERIVATIVES CALCULATED
!     IX,IY,IZ    -  MODEL SEGMENT CURRENTLY BEING ANALYZED
!     LIST(5)     -  OPTIONS TO LIST COMPONENTS OF MODEL INPUT DECK 
!                   = 0 - DO NOT LIST INPUT
!                   = 1 - PROVIDE USER WITH LIST OF INPUT
!                   LIST(1) - GEOMETRY
!                   LIST(2) - Boundary CONDITIONS
!                   LIST(3) - LOADS
!                   LIST(4) - PARAMETERS, CONSTANTS AND TIME FUNCTIONS
!                   LIST(5) - INITIAL CONDITIONS
! 
! 
!     IDISK       -  FLAG WHICH SIGNALS -TUNER- TO INITIATE DISK STORAGE 
!                    OF VARIABLES THAT USER WISHES TO DUMP AT END OF RUN 
!     IPRNTGSECS  -  PRINT INTERVAL (IN SECONDS) REQUESTED FOR GLOBAL
!                    DUMPS 
!     NXPRTG      -  NEXT PRINT TIME (IN SECONDS) REQUESTED FOR GLOBAL
!                    DUMPS
!     IGDOPT      -  GLOBAL DUMP TIME-AVERAGING OPTION
!                    = 0 - NO TIME-AVERAGING, I.E. INSTANTANEOUS VALUE
!                    = 1 - PERFORM TIME-AVERAGING WILL BE PERFORMED
!     IAVGGDCNTR  -  COUNTER TO KEEP TRACK OF NUMBER OF INTEGRATION STEPS GOING
!                    INTO GLOBAL DUMP AVERAGE
!     IDUMP       -  ARRAY CONTAINING THE SEGMENTS NUMBERS TO BE PRINTED AS
!                    PART OF THE INTERMEDIATE DUMPS, I.E. THE SIX SEGMENTS
!                    WHICH ARE DUMPED TO STANDOUT OUT DURING THE COURSE OF
!                    THE MODEL SIMULATION (PRINTED AT INTERVAL 'IPRNTGSECS')
!     IPRNTDSECS  -  PRINT INTERVAL (IN SECONDS) USED TO GENERATE THE
!                    'DETAILED' DUMPS FOR SELECTED SEGMENTS (VIA RCAWRIT)
!     NXPRTD      -  NEXT PRINT TIME (IN SECONDS) USED TO GENERATE THE
!                    'DETAILED' DUMPS FOR SELECTED SEGMENTS (VIA RCAWRIT)
!     IDDOPT      -  DETAILED DUMP TIME-AVERAGING OPTION
!                    = 0 - NO TIME-AVERAGING, I.E. INSTANTANEOUS VALUE
!                    = 1 - PERFORM TIME-AVERAGING WILL BE PERFORMED
!     IAVGDDCNTR  -  COUNTER TO KEEP TRACK OF NUMBER OF INTEGRATION STEPS GOING
!                    INTO DETAILED DUMP AVERAGE
!     NDMPS       -  NUMBER OF SEGMENTS SPECIFIED FOR DETAILED OUTPUT
!                    DUMPS AT PRINT INTERVAL 'IPRNTDSECS'
!     IFDMPS      -  ARRAY CONTAINING LIST OF SEGMENT NUMBERS FOR WHICH
!                    'DETAILED' DUMPS, I.E. CONCENTRATIONS AND OTHER SECONDARY 
!                    VARIABLES OF INTEREST ARE TO BE SAVED VIA RCAWRIT
!     IREC        -  COUNTER USED BY RCA FOR GLOBAL DUMP DISK FILE STORAGE 
!
!     MASSBAL     -  MASS BALANCE/FLUX BALANCE OPTION
!                    = 0 - NO BALANCES REQUESTED
!                    = 1 - PERFORM MASS/FLUX BALANCE COMPUTATIONS
!     IPRNTMBSECS -  PRINT INTERVAL (IN SECONDS) FOR OUTPUTING BALANCE
!                    COMPUTATIONS
!     NXPRTMB     -  NEXT TIME (IN SECONDS) TO OUTPUT THE BALANCE
!                    COMPUTATIONS
!     IMBOPT      -  MASS/FLUX BALANCE TIME-AVERAGING OPTION
!                    = 0 - NO TIME-AVERAGING, I.E. INSTANTANEOUS VALUE
!                    = 1 - PERFORM TIME-AVERAGING WILL BE PERFORMED
!     IAVGMBCNTR  -  COUNTER TO KEEP TRACK OF NUMBER OF INTEGRATION STEPS GOING
!                    INTO THE MASS/FLUX BALANCE AVERAGE

!
!
!     SYNAME      -  ALPHA-NUMERIC NAMES FOR EACH SYSTEM 
!     SYSBY       -  VECTOR CONTAINING BYPASS OPTION FOR EACH SYSTEM 
!     RBY         -  VECTOR CONTAINING R BYPASS INDICATOR FOR EACH SYSTEM
!     QBY         -  VECTOR CONTAINING Q BYPASS INDICATOR FOR EACH SYSTEM
!     CYCLE       -  FLAG TO DETERMINE WHETHER INITIAL CONDITIONS ARE TO BE
!                    READ FROM A USER PROVIDED INPUT FILE OR FROM A PREVIOUS
!                    RCA RUN (I.E. THE EQUIVALENT OF A HOT -START); MAY ALSO BE
!                    USED TO LINK A SERIES OF MULTI -YEAR SIMULATIONS TOGETHER
!                    = 0 - GET INITIAL CONDITIONS FROM USER SUPPLIED INPUT
!                            FILE (EQUIVALENT TO A COLD -START RUN)
!                    = 1 - GET INITIAL CONDITIONS FROM A PREVIOUS RCA RUN -
!                            THE RCAFIC FILE (EQUIVALENT TO A HOT -START RUN)
!     NEGSLN      -  VARIABLE INDICATING WHETHER OR NOT NEGATIVE SOLUTIONS 
!                    WILL BE PERMITTED 
!                    = 0 - NEGATIVE SOLUTIONS NOT PERMITTED  (FLOOR = 0.0) 
!                    = 1 - NEGATIVE SOLUTIONS PERMITTED  (FLOOR = -1.E 35) 
!     INTGRTYP    -  INTEGRATION METHOD
!                    = 1 - EXPLICIT - UPWIND
!                    = 3 - SPLIT TIME STEP - UPWIND
!                    = 4 - EXPLICIT - UPWIND/SMOLARKIEWICZ
!                    = 5 - LEAPFROG - UPWIND/SMOLARKIEWICZ
!                    = 6 - SPLIT TIME STEP - UPWIND/SMOLARKIEWICZ
!     ISMOLAR     -  SMOLARKIEWICZ CORRECTOR OPTION
!                    = 0 - ECOM3D SMOLAR_2 - SECOND ORDER ACCURATE SCHEME
!                    = 1 - ECOM3D SMOLAR_R - RECURSIVE SCHEME
!     ISMOLBCOPT  -  BOUNDARY SMOLARKIEWICZ CORRECTOR OPTION
!                    = 0 - DO NOT APPLY SMOLARKIEWICZ CORRECTIONS AT
!                          BOUNDARY CONDITIONS
!                    = 1 - APPLY SMOLARKIEWICZ CORRECTIONS AT BOUNDARY
!                          CONDITIONS
!     IDIAGDT     -  FLAG USED TO SELECT WHETHER A FULL SIMULATION IS TO BE
!                    PERFORMED OR WHETHER A DIAGNOSTIC ANALYSIS OF INTEGRATION
!                    STEPSIZES IS TO BE PERFORMED
!                    = 0 - PERFORM MODEL SIMULATION
!                    = 1 - DETERMINE CRITICAL INTEGRATION STEPSIZES
!     INPCHCK     -  FLAG USED TO SELECT WHETHER A FULL SIMULATION IS TO BE
!                    PERFORMED OR WHETHER A CHECK OF THE USER'S INPUT DECK
!                    FOR ERRORS IS TO BE PERFORMED
!                    = 0 - PERFORM MODEL SIMULATION
!                    = 1 - CHECK INPUT DECK FOR ERRORS
!     CARAY       -  CONCENTRATIONS FOR APPROPRIATE SYSTEM AND SEGMENT 
!     CDARAY      -  CONCENTRATION DERIVATIVES
!     CMAX        -  MAXIMUM ALLOWABLE CONCENTRATION FOR EACH SYSTEM 
!                    IF ANY OF THESE VALUES ARE EXCEEDED IN THEIR RESPECTIVE  
!                    SYSTEMS THE PROGRAM WILL ABORT
!     CMIN        -  MINIMUM CONCENTRATIONS, FOR EACH SYSTEM, BELOW WHICH
!                    THE ACCURACY CRITERIA IS IGNORED
!
!   /TIMEINFO/  VARIABLES ASSOCIATED WITH SIMULATION TIME AND
!               INTEGRATION HISTORY
!     INITB       -  FLAG WHICH PERMITS THE USER TO PROVIDE INITIALIZATION 
!                    OF VARIABLES IN KINETIC SUBROUTINE    - TUNER-
!     IDTSECS     -  INTEGRATION INTERVAL - SECONDS
!     ITIMESECS   -  INTERNAL CLOCK USED TO KEEP TRACK OF THE
!                    SIMULATION TIME  - SECONDS
!     IDTWQSECS   -  INTEGRATION STEPSIZE TO BE USED FOR EVALUATING THE
!                    KINETIC PORTION OF THE MASS BALANCE EQUATIONS -
!                    SECONDS
!     ITIMEWQSECS -  INTERNAL CLOCK USED TO KEEP TRACK OF KINETIC PORTION OF
!                    THE INTEGRATION PROCEDURE - SECONDS
!     TZERO       -  TIME USER WISHES TO START SIMULATION AT, OR TIME FOR
!                    WHICH THE USER WANTS A STEADY STATE SOLUTION
!     DT          -  INTEGRATION INTERVAL - DAYS
!     TIME        -  INTERNAL CLOCK USED TO KEEP TRACK OF THE
!                    SIMULATION TIME - DAYS
!     DTWQ        -  INTEGRATION STEPSIZE TO BE USED FOR EVALUATING THE
!                    KINETIC PORTION OF THE MASS BALANCE EQUATIONS - DAYS
!     TIMEWQ      -  INTERNAL CLOCK USED TO KEEP TRACK OF KINETIC PORTION OF
!                    THE INTEGRATION PROCEDURE - DAYS
!     ISCALT      -  TIME WARP FACTOR ... TIME CONVERSION FACTOR - INTEGER 
!     SCALT       -  TIME WARP FACTOR ... TIME CONVERSION FACTOR - REAL 
!     TEND        -  ENDING TIME OF SIMULATION (OR TIME TO CHANGE 
!                    TO NEXT INTEGRATION INTERVAL) - DAYS
!
!
!   /INTHIST/  VARIABLES ASSOCIATED WITH INTEGRATION HISTORY TIMESTEPS
!     NSTEP       -  NUMBER OF INTEGRATION STEPSIZES/TIMES TO BE USED
!                    FOR DESCRIBING THE INTEGRATION HISTORY
!     ISTEP       -  VECTOR CONTAINING THE INTEGRATION STEPSIZES - DT (SECS)
!     TBRK        -  VECTOR CONTAINING THE CORRESPONDING TIMES FOR THE VECTOR
!                    -ISTEP-. ISTEP(I) WILL BE USED UNTIL TIME TBRK(I), THEN
!                    SWITCH TO ISTEP(I+1) UNTIL TBRK(I+1), ETC.
!
!
!   /FILENAMES/  VARIABLES ASSOCIATED WITH READING MODEL INPUTS
!     IHYDFILE    -  COUNTER TO KEEP TRACK OF WHICH HYDRODYNAMIC FILE
!                    TO OPEN AND READ
!     HYDFILNA    -  VECTOR CONTAINING NAMES OF THE HYDRODYNAMIC FILES
!     DIFFILNA    -  VECTOR CONTAINING NAMES OF THE DIFFUSER FILES
!     BCFILNA     -  NAME OF THE FILE CONTAINING BOUNDARY CONDITIONS
!     PSFILNA     -  NAME OF THE FILE CONTAINING POINT SOURCE LOADS
!     NPSFILNA    -  NAME OF THE FILE CONTAINING NONPOINT SOURCE LOADS
!     FLFILNA     -  NAME OF THE FILE CONTAINING FALL-LINE LOADS
!     ATMFILNA    -  NAME OF THE FILE CONTAINING ATMOSPHERIC LOADS
!     PCFILNA     -  NAME OF THE FILE CONTAINING PARAMETERS, CONSTANTS,
!                    MISCELLANEOUS TIME FUNCTIONS AND FILE NAMES FOR
!                    MISCELLANEOUS INPUT FILES REQUIRED BY A USER'S
!                    KINETIC SUBROUTINE
!     KINFILNA    -  NAMES OF THE MISCELLANEOUS INPUT FILES TO BE USED
!                    FOR A USER'S KINETIC SUBROUTINE (EX. INPUT REQ'D
!                    WHEN USING THE SEDIMENT NUTRIENT FLUX MODEL AS PART
!                    OF A EUTROPHICATION ANALYSIS)
!     ICFILNA     -  NAME OF THE FILE CONTAINING INITIAL CONDITIONS
!     IBNRYRDOPTS -  VECTOR SPECIFYING WHETHER ASCII OR BINARY FILES
!                    WILL BE READ FOR BOUNDARY CONDITIONS, LOADS, AND
!                    INITIAL CONDITIONS
!                    = 0 - ASCII FILE
!                    = 1 - BINARY FILE
! 
! 
!   /UNITS/  VARIABLES ASSOCIATED WITH "SCALING" OF TIME FOR READING
!            INPUT VARIABLES
!     TWARP       -  INTEGRATION TIME
!     TWARPP      -  PRINT INTERVALS
!     TWARPBC     -  BOUNDARY CONDITION
!     TWARPPS     -  POINT SOURCE LOADS
!     TWARPNPS    -  NONPOINT SOURCE LOADS
!     TWARPFL     -  FALL-LINE LOADS
!     TWARPATM    -  ATMOSPHERIC LOADS
!     TWARPTVF    -  MISCELLANEOUS TIME FUNCTIONS
!     ISCALBC     -  BOUNDARY CONDITION
!     ISCALPS     -  POINT SOURCE LOADS
!     ISCALNPS    -  NONPOINT SOURCE LOADS
!     ISCALFL     -  FALL-LINE LOADS
!     ISCALATM    -  ATMOSPHERIC LOADS
!     ISCALTVF    -  MISCELLANEOUS TIME FUNCTIONS
! 
! 
!   /VOLUMES/  MODEL VOLUMES AND VARIABLES ASSOCIATED WITH READING
!              HYDRODYNAMIC FILES
!     IHYDDTSECS  -  INTERVAL (IN SECONDS) BETWEEN HYDRODYNAMIC UPDATES
!                    (I.E., THE PERIOD USED TO AVERAGE TRANSPORT
!                    COMPUTATIONS IN THE HYDRODYNAMIC MODEL)
!     HYDDT       -  INTERVAL (IN DAYS) BETWEEN HYDRODYNAMIC UPDATES
!     NXHYDTSECS  -  TIME (IN SECONDS) AT WHICH THE NEXT READ OF THE
!                    HYDRODYNAMIC FILE IS TO OCCUR
!    NXHYDTSECS  -  TIME (IN DAYS) AT WHICH THE NEXT READ OF THE
!                    HYDRODYNAMIC FILE IS TO OCCUR
!    HYDCYCOPT   -  FLAG TO SPECIFY WHETHER THE HYDRODYNAMIC INPUT FILE
!                    IS TO CYCLED (I.E., RE-READ)
!                    = 1 - HYDRODYNAMIC FILE IS TO BE CYCLED (SAME AS
!                          ASSUMMING A PERIODIC STEADY STATE FOR HYDRO)
!                    = 2 - NO CYCLING
!     BVOL        -  VECTOR CONTAINING VOLUMES (MCM)
!     VDER        -  VOLUME DERIVATIVES (MCM/DAY)

!   /PARCONFNS/  VARIABLES ASSOCIATED WITH PARAMETERS, CONSTANTS, AND
!                MISCELLANEOUS TIME FUNCTIONS
!     PARAM2D     -  2-D ARRAY CONTAINING PARAMETERS FOR EACH LAYER
!     PARAM3D     -  3-D ARRAY CONTAINING PARAMETERS FOR EACH SEGMENT
!     NOCONS      -  NUMBER OF CONSTANTS 
!     CONST       -  A VECTOR OF CONSTANTS COMMON ACROSS ALL SEGMENTS
!     NOFUNC      -  NUMBER OF MISCELLANEOUS TIME FUNCTIONS 
!     ITVFPWLOPT  -  FLAG SPECIFYING WHETHER THE TIME FUNCTIONS WILL BE
!                    EVALUATED AS STEP FUNCTIONS OR PIECEWISE LINEAR
!                    FUNCTIONS
!                    = 0 - STEP FUNCTIONS
!                    = 1 - PIECEWISE LINEAR INTERPOLATION
!     NXFUNTSECS  -  NEXT TIME (IN SECONDS) TO UPDATE TIME FUNCTION
!     NXFUNT      -  NEXT TIME (IN DAYS) TO UPDATE TIME FUNCTION
!     NXCALL13T   -  NEXT TIME (IN DAYS) TO CALL RCA13 - SUBROUTINE
!                    THAT UPDATES THE TIME FUNCTIONS
!     ITIMF       -  COUNTER THAT TRACKS THE TIME BREAKS FOR THE
!                    MISCELLANEOUS TIME FUNCTIONS
!     MFUNC       -  VECTOR CONTAINING 'SLOPE' OF THE KINETIC TIME FUNCTIONS
!     BFUNC       -  VECTOR CONTAINING THE INTERCEPT OF THE KINETIC TIME
!                    FUNCTIONS 
!     VALMTF      -  VALUES OF THE MISCELLANEOUS TIME FUNCTIONS
!     TIMEMTF     -  TIME BREAKS FOR THE MISCELLANEOUS TIME FUNCTIONS
!
! 
!   /BOUNDCOND/  VARIABLES ASSOCIATED WITH THE BOUNDARY CONDITIONS
!     IBCOPT      -  BC OPTION
!                    = 1 - SIGMA LEVEL - CONSTANT
!                    = 2 - SIGMA LEVEL - TIME-VARYING
!                    = 3 - STANDARD LEVEL - CONSTANT
!                    = 4 - STANDARD LEVEL - TIME-VARYING
!     IBCPWLOPT   -  PIECEWISE LINEAR BOUNDARY CONCENTRATION OPTION
!                    = 0 - STEP FUNCTION APPROXIMATION FOR BCS
!                    = 1 - PIECEWISE LINEAR APPROXIMATION FOR BCS
!     NOBC        -  NUMBER OF B.C.'S FOR EACH SYSTEM
!     NXBCTSECS   -  NEXT TIME (IN SECONDS) TO UPDATE BOUNDARY CONDITIONS
!     NXBCT       -  NEXT TIME (IN DAYS) TO UPDATE BOUNDARY CONDITIONS
!     SCALBC      -  SCALE FACTORS FOR BOUNDARY CONDITIONS
!     IBC         -  VECTOR CONTAINING THE (I,J,K) LOCATIONS OF THE
!                    BOUNDARY CONDITIONS
!     BBC         -  VECTOR CONTAINING BOUNDARY CONDITIONS (MG/L)
!     SBC         -  VECTOR CONTAINING 'SLOPE' OF BOUNDARY CONDITIONS
!                    PER SYSTEM
!     SLDEPTH     -  STANDARD LEVEL DEPTHS (IF BCS TO BE READ USING
!                    STANDARD LEVEL OPTION)
!     NOBCSL      -  NUMBER OF STANDARD LEVELS FOR EACH BC
!
!
!   /FORCFNS/  VARIABLES ASSOCIATED WITH THE FORCING FUNCTIONS (I.E., THE LOADS)
!     IPSOPT      -  PS LOADING OPTION (1==>CONSTANT;2==>TIME-VARYING)
!     IPSPWLOPT   -  FLAG TO SPECIFY WHETHER TIME VARIABLE POINT SOURCE
!                    LOADS ARE STEP-FUNCTIONS OR PIECEWISE LINEAR
!     NOPS        -  NUMBER OF PS LOADS FOR EACH SYSTEM
!     IPSTABL     -  INDEX TABLE OF POINT SOURCE LOADS
!     ZFRACPS     -  VERTICAL DISTRIBUTION FOR EACH POINT SOURCE LOAD
!                    CONTAINED IN -IPSTABL-
!     NXPSTSECS   -  NEXT TIME (IN SECONDS) TO UPDATE POINT SOURCE LOADS
!     NXPST       -  NEXT TIME (IN DAYS) TO UPDATE POINT SOURCE LOADS
!     SCALPS      -  SCALE FACTORS FOR POINT SOURCE LOADS
!     IPS         -  VECTOR CONTAINING (I,J,K) LOCATIONS OF THE POINT
!                    SOURCE LOADS
!     BPS         -  VECTOR CONTAINING POINT SOURCE LOADS (GM/DAY)
!     SPS         -  VECTOR CONTAINING 'SLOPE' OF POINT SOURCE LOADS
!     INPSOPT     -  NPS OPTION (1==>CONSTANT;2==>TIME-VARYING)
!     INPSPWLOPT  -  FLAG TO SPECIFY WHETHER TIME VARIABLE NONPOINT SOURCE
!                    LOADS ARE STEP-FUNCTIONS OR PIECEWISE LINEAR
!     NONPS       -  NUMBER OF NPS LOADS FOR EACH SYSTEM
!     INPSTABL    -  INDEX TABLE OF NONPOINT SOURCE LOADS
!     ZFRACNPS    -  VERTICAL DISTRIBUTION FOR EACH NONPOINT SOURCE LOAD
!                    CONTAINED IN -INPSTABL-
!     NXNPSTSECS  -  NEXT TIME (IN SECONDS) TO UPDATE NONPOINT SOURCE LOADS
!     NXNPST      -  NEXT TIME (IN DAYS) TO UPDATE NONPOINT SOURCE LOADS
!     SCALNPS     -  SCALE FACTORS FOR NONPOINT SOURCE LOADS
!     INPS        -  VECTOR CONTAINING (I,J,K) LOCATIONS OF THE NONPOINT
!                    SOURCE LOADS
!     BNPS        -  VECTOR CONTAINING NONPOINT SOURCE LOADS (GM/DAY)
!     SNPS        -  VECTOR CONTAINING 'SLOPE' OF NONPOINT SOURCE LOADS
!     IFLPWLOPT   -  FLAG TO SPECIFY WHETHER TIME VARIABLE FALL-LINE
!                    LOADS ARE STEP-FUNCTIONS OR PIECEWISE LINEAR
!     NOFL        -  NUMBER OF FL LOADS FOR EACH SYSTEM
!     IFLTABL     -  INDEX TABLE OF FALL-LINE LOADS
!     ZFRACFL     -  VERTICAL DISTRIBUTION FOR EACH FALL-LINE LOAD
!                    CONTAINED IN -IFLTABL-
!     NXFLTSECS   -  NEXT TIME (IN SECONDS) TO UPDATE FALL-LINE LOADS
!     NXFLT       -  NEXT TIME (IN DAYS) TO UPDATE FALL-LINE LOADS
!     SCALFL      -  SCALE FACTORS FOR FALL-LINE LOADS
!     IFL         -  VECTOR CONTAINING (I,J,K) LOCATIONS OF THE FALL-LINE
!                    LOADS
!     BFL         -  VECTOR CONTAINING FALL-LINE LOADS (GM/DAY)
!     SFL         -  VECTOR CONTAINING 'SLOPE' OF FALL-LINE LOADS
!     IFLOPT      -  FALL-LINE OPTION (1==>CONSTANT;2==>TIME-VARYING)
!     IATMOPT     -  ATMOSPHERIC OPTION (1==>CONSTANT;2==>TIME-VARYING)
!     IATMPWLOPT  -  FLAG TO SPECIFY WHETHER TIME VARIABLE ATMOSPHERIC
!                    LOADS ARE STEP-FUNCTIONS OR PIECEWISE LINEAR
!     NOATM       -  NUMBER OF LOADS FOR EACH SYSTEM
!     NXATMTSECS   -  NEXT TIME (IN SECONDS) TO UPDATE ATMOSPHERIC LOADS
!     NXATMT       -  NEXT TIME (IN DAYS) TO UPDATE ATMOSPHERIC LOADS
!     SCALATM     -  SCALE FACTORS FOR ATMOSPHERIC LOADS
!     BATM        -  VECTOR CONTAINING ATMOSPHERIC LOADS (GM/DAY)
!     SBATM       -  VECTOR CONTAINING 'SLOPE' OF ATMOSPHERIC LOADS
! 
!
!   /TRANSCOEFFS/  VARIABLES ASSOCIATED WITH THE TRANSPORT COEFFICIENTS
!     IXS,IXE     -  STARTING AND ENDING LOCATIONS OF WATER CELLS FOR
!                    EACH "ROW" IN THE WATER QUALITY MODEL
!     QX,QY,QZ    -  ARRAYS CONTAINING THE ADVECTIVE FLOWS (MCM/DAY)
!     RX,RY,RZ    -  ARRAYS CONTAINING THE BULK EXCHANGE COEFFICIENTS (MCM/DAY)
!     SCALRX      -  SCALE FACTOR FOR HORIZONTAL EXCHANGE FIELD
!     SCALRY      -  SCALE FACTOR FOR LATERAL EXCHANGE FIELD
!     SCALRZ      -  SCALE FACTOR FOR VERTICAL EXCHANGE FIELD
!     AVECT       -  VECTOR CONTAINING THE OFF-DIAGONAL TERMS OF THE
!                    TRANSPORT MATRIX
!     DIAG        -  VECTOR CONTAINING THE DIAGONAL TERMS OF THE TRANSPORT
!                    MATRIX
!     EX,EY,EZ    -  ARRAYS CONTAINING THE MIXING COEFFICIENTS (MCM/DAY)
!     IDIFFOPT    -  FLAG SPECIFYING WHETHER DIFFUSER DISCHARGE FILE
!                    BEING READ
!     IDD,JDD     -  (I,J) LOCATIONS OF THE DIFFUSERS
!     VDDIST      -  VERTICAL DISTRIBUTION (FRACTIONS) OF DIFFUSER FLOWS
!                    THROUGH THE WATER COLUMN
!     QDIFF       -  DIFFUSER DISCHARGE FLOW RATES (MCM/DAY)
! 
! 
!   /GEOM/  VARIABLES ASSOCIATED WITH THE LENGTHS, WIDTHS, AND DEPTHS OF
!           THE WATER QUALITY MODEL
!     ICOLLOPT    -  FLAG WHICH SPECIFIES WHETHER A GRID-COLLAPSED
!                    VERSION OF THE HYDRODYNAMICS BEING PROVIDED TO RCA
!     LNDWTROPT   -  FLAG WHICH SPECIFIES WHETHER FULL GRID HYDRODYNAMIC
!                    TRANSPORT BEING READ OR WET-GRID ONLY
!     IWTRCNT     -  THE NUMBER OF WET-GRID CELLS
!     IWTRNDX     -  THE -I- LOCATIONS OF THE WET CELLS
!     JWTRNDX     -  THE -J- LOCATIONS OF THE WET CELLS
!     FSM         -  LAND MASK ARRAY
!     H           -  MEAN WATER DEPTH ARRAY (M)
!     DETA        -  WATER ELEVATION DERIVATIVE ARRAY (M/day)
!     ETA         -  WATER ELEVATION (RELATIVE TO MEAN WATER -H-) ARRAY (M)
!     HBAR        -  WATER DEPTH (H+ETA) ARRAY (M)
!     DZ          -  THICKNESS OF EACH SIGMA-LEVEL
!     DZZ         -  AVERAGE THICKNESS BETWEEN LEVELS
!     ZZ          -  SIGMA-LEVEL DEPTH OF A VERTICAL CELL
!     DZ          -  "LENGTHS" OF EACH WATER CELL (M)
!     DY          -  "WIDTHS" OF EACH WATER CELL (M)
!     XAX         -  CROSS-SECTIONAL AREA (ON X-INTERFACE) OF EACH WATER
!                    CELL (M^2)
!     XAY         -  CROSS-SECTIONAL AREA (ON Y-INTERFACE) OF EACH WATER
!                    CELL (M^2)
!     XAZ         -  SURFACE AREA OF EACH WATER CELL (M^2)
! 
! 
!   /SALTEMP/  SALINITY AND TEMPERATURE FROM THE HYDRO MODEL
!     HYDSAL      -  HYDRODYNAMIC MODEL COMPUTED SALINITY
!     HYDTEMP     -  HYDRODYNAMIC MODEL COMPUTED TEMPERATURE
!
!     ITIMX       -  COUNTER USED TO PICK PROPER 'B' VALUES FOR....
!     ITIMHYD     -  FOR HYDRODYNAMIC FIELDS
!     ITIMF       -  FOR MISC TIME FUNCTIONS 

      USE ALL_VARS
      USE MOD_RCA
      USE MOD_NCD
# if defined (MULTIPROCESSOR)
      USE MOD_PAR
# endif            
    
      IMPLICIT NONE
      SAVE
!      INCLUDE  'RCACM'
      REAL :: ADDMASS(NXY,NZ,NOSYS)
      REAL :: TOTMASS,CONCMASS
      REAL,ALLOCATABLE :: BVOL_TMP(:,:)
      INTEGER :: IERR
  
!               RCA FILE STRUCTURE
!    FILE        
!     NO.  TYPE     NAME            USAGE 
!    ----  ----    ------      -------------------------
!
!      5   ASCII               STANDARD INPUT
!      6   ASCII               STANDARD OUTPUT
!
!     10   BINARY  RCAF10      PRINT TIME HISTORY FOR 'GLOBAL' DUMPS
!                              (+ NX, NY, NZ, NOSYS AS REC 1)
!                              (+ SYSTEM NAMES AS REC 2)
!                              (+ SYSBY AS REC 3)
!                              (+ FSM LAND MASK AS REC 4)
!     11   BINARY  RCAF11      CONCENTRATIONS FOR EACH MODEL SEGMENT
!     12   BINARY  RCAF12      PRINT TIME HISTORY FOR MORE DETAILED
!                              SEGMENT DUMPS
!                              (+ NOSEG DUMPED AS REC 1)
!                              (+ EQUIV TABLE OF SEGS SAVED AS REC 2)
!     13   BINARY  RCAF13      MORE DETAILED DUMPS FOR SELECTED SEGMENTS
!     14   BINARY  RCAF14      SEDIMENT LAYER DUMP FILES (IF USER MODEL
!                              INCLUDES A SEDIMENT COMPONENT)
!     15   BINARY  RCAFIC      WATER COLUMN ICs FOR MULTI-YEAR RUNS
!     16   BINARY  RCAFICSED   INITIAL CONDITIONS FOR MULTI-YEAR RUNS
!     17   BINARY  RCAFMB      WATER COLUMN MASS BALANCE/FLUX BALANCE DUMPS
!     18   BINARY  RCAFMBSED   SEDIMENT MASS BALANCE/FLUX BALANCE DUMPS
!     19   BINARY  RCAFADDM    MASS ADDED DUMPS (I.E., THE MASS ADDED TO
!                              EACH SYSTEM/SEGMENT WHEN NEGATIVE
!                              CONCENTRATIONS ENCOUTERED DURING THE
!                              INTEGRATION PROCEDURE)
!
!   20-29    *        *        CAN BE USED FOR SPECIFIC APPLICATIONS AS
!                              OUTPUT FILES AS NEEDED BY DEFINING IN THE
!                              USER-SPECIFIED KINETIC SUBROUTINE -TUNER-
!
!     30   BINARY  gcm_geom    GEOMETRY AS SUPPLIED FROM HYDRODYNAMIC MODEL
!     30   BINARY  wet_grid    (IX,IY) LOCATIONS OF THE WATER SEGMENTS
!                              IN THE HYDRODYNAMIC MODEL
!     30   BINARY  HYDFILNA    TRANSPORT TERMS AS SUPPLIED FROM HYDRODYNAMIC
!                              MODEL (THIS IS THE ECOM-3D gcm_trans FILE)
!     31   BINARY  DIFFILNA    DIFFUSER (OUTFALL) DISCHARGE VOLUMES AS SUPPLIED
!                              FROM HYDRODYNAMIC MODEL (THIS IS THE ECOM-3D
!                              gcm_qdiff FILE)
!     32   A-or-B  BCFILNA     USER SELECTED FILE FOR BOUNDARY CONDITIONS
!     33   A-or-B  PSFILNA     USER SELECTED FILE FOR POINT SOURCE LOADS
!     34   A-or-B  NPSFILNA    USER SELECTED FILE FOR NONPOINT SOURCE LOADS
!     35   A-or-B  FLFILNA     USER SELECTED FILE FOR FALL -LINE LOADS
!     36   A-or-B  ATMFILNA    USER SELECTED FILE FOR ATMOSPHERIC LOADS
!     37   A-or-B  PCFILNA     USER SELECTED FILE FOR PARAMETERS, CONSTANTS
!                              AND MISCELLANEOUS TIME FUNCTIONS
!     38   A-or-B  ICFILNA     USER SELECTED FILE FOR INITIAL CONDITIONS
!
!   39-49    *        *        CAN BE USED FOR SPECIFIC APPLICATIONS AS
!                              INPUT FILES AS NEEDED BY DEFINING IN THE
!                              USER  - SPECIFIED KINETIC SUBROUTINE -TUNER-
!
!      A-or-B = ASCII or BINARY - as specified by user selected option
!      *  AS DEFINED BY THE USER
! 

!==============================================================================!
!   SETUP PARALLEL ENVIRONMENT                                                 !
!==============================================================================!

      SERIAL = .TRUE. 
      PAR    = .FALSE. 
      MSR    = .TRUE.
      MYID   = 1
      NPROCS = 1
#  if defined (MULTIPROCESSOR)
      CALL INIT_MPI_ENV(MYID,NPROCS,SERIAL,PAR,MSR)
#  endif

      IF(MSR)THEN
       OPEN(UNIT=10,FILE='RCAF10',FORM='UNFORMATTED')
       OPEN(UNIT=11,FILE='RCAF11',FORM='UNFORMATTED')
       OPEN(UNIT=15,FILE='RCAFIC',FORM='UNFORMATTED')

!  Open files for sediment dumps and initial conditions
     !  OPEN(UNIT=14,FILE='RCAF14',FORM='UNFORMATTED')
     !  OPEN(UNIT=16,FILE='RCAFICSED',FORM='UNFORMATTED')
    
      END IF 

!  Open and close/delete "mass added" file
      IF(MSR)THEN
      OPEN(19,FILE='RCAFADDM',FORM='UNFORMATTED')
      CLOSE(19,STATUS='DELETE')
      END IF
! 
!     Calling sequence for RCA subroutines 
! 
!     Call input routines
      CALL RCA01
      CALL RCA02
      if(msr)print*,"BEFORE RCA03"
      CALL RCA03
      if(msr)print*,"AFTER RCA03"
!      pause 1

# if defined (MULTIPROCESSOR)
      CALL GLOB2LOC02
# endif
     
       if(msr)print*,"BEFORE RCA04"
    CALL RCA04


       if(msr)print*,"BEFORE RCA05"
      CALL RCA05

!JQI# if defined (MULTIPROCESSOR)        
!JQI      IF(PAR)CALL MPI_BARRIER(MPI_COMM_WORLD,IERR)  !Tian CPP
!JQI# endif      

     IF(SERIAL)THEN
       ZFRACPS  = ZFRACPS_GL
       ZFRACNPS = ZFRACNPS_GL
       ZFRACFL  = ZFRACFL_GL
     END IF
# if defined (MULTIPROCESSOR) 
   CALL GLOB2LOC05
   IF(PAR)CALL MPI_BARRIER(MPI_COMM_WORLD,IERR) 
# endif

       if(msr)print*,"BEFORE RCA06"
      CALL RCA06

# if defined (MULTIPROCESSOR)
     CALL GLOB2LOC06
   IF(PAR)CALL MPI_BARRIER(MPI_COMM_WORLD,IERR)     
# endif

       if(msr)print*,"BEFORE RCA07"
      CALL RCA07     

      IF(INPCHCK.EQ.1)  THEN
        IF(MSR) WRITE(OUT,1000)
 1000   FORMAT(///25X,'CHECK OF RCA INPUT COMPLETED --- PROGRAM TERMINATED'//)
!JQI        CALL EXIT
	CALL PSTOP('rca568    ')
      ENDIF

!     Call subroutines to solve state equations
!       Time-variable
      INTGRTYP = 4
      print*,'INTGRTYP = ',INTGRTYP

       if(msr)print*,"BEFORE RCAADV"
      CALL RCAADV 
       if(msr)print*,"AFTER RCAADV"

!     Check to see if mass added to any of the state-variables,
!        if so, inform user
      OPEN(19,FILE='RCAFADDM',FORM='UNFORMATTED',STATUS='OLD',ERR=100)
!        RCAFADDM file exists, therefore mass added
      IF(MSR) WRITE(OUT,2000)
 2000 FORMAT(///20X,'DURING THIS SIMULATION RUN MASS WAS ADDED AS FOLLOWS...')
      READ(19)  ADDMASS
      print*,'after read ADDMASS'
      
      ALLOCATE(BVOL_TMP(NXY,NZ))    ;BVOL_TMP = 0.0
      IF(SERIAL) BVOL_TMP(1:NXY,1:NZ) = BVOL(1:NXY,1:NZ)
#  if defined (MULTIPROCESSOR)
      IF(PAR)THEN
       CALL GATHER(LBOUND(BVOL,1),UBOUND(BVOL,1),M,NXY,1,     &
                   MYID,NPROCS,NMAP,BVOL,BVOL_TMP)
      END IF 
#  endif
      
      DO ISYS=1,NOSYS
       IF(MSR) WRITE(OUT,2100)  ISYS
 2100  FORMAT(//20X,'SYSTEM',I3/13X,'IXY   IZ',3X,'MASS ADDED',9X,'EQUIVALENT CONC')
       TOTMASS=0.
       DO IZ=1,NZ
        DO IXY=1,NXY
         IF(ADDMASS(IXY,IZ,ISYS) /= 0.) THEN
          TOTMASS = TOTMASS+ADDMASS(IXY,IZ,ISYS)
!JQI          CONCMASS = ADDMASS(IXY,IZ,ISYS)/BVOL(IXY,IZ)
          CONCMASS = ADDMASS(IXY,IZ,ISYS)/BVOL_TMP(IXY,IZ)
          IF(MSR) WRITE(OUT,2200)  IXY,IZ,ADDMASS(IXY,IZ,ISYS)/1000.,CONCMASS
 2200     FORMAT(10X,2I5,E13.5,' KG',5X,E13.5,' MG/L')
         END IF
        END DO
       END DO	
       IF(TOTMASS > 0. .AND. MSR)  WRITE(OUT,2300) ISYS,TOTMASS/1000.
 2300  FORMAT(20X,'TOTAL MASS ADDED FOR SYSTEM',I5,' =',E13.5,' KG')
      END DO

      DEALLOCATE(BVOL_TMP)

!     Call output routines
  100 CALL RCA12

!     Close files
      IF(MSR)THEN
       CLOSE (10,STATUS='KEEP')
       CLOSE (11,STATUS='KEEP')
       CLOSE (13,STATUS='KEEP')
      END IF 

!JQI      CALL EXIT 
      CALL PSTOP('rca628    ')
      
      END 
