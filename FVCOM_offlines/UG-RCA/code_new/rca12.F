      SUBROUTINE RCA12
!
!     RCA12 PRINTS USER REQUESTED DUMPS AT END OF SIMULATION
!
      USE ALL_VARS, ONLY : MSR,SERIAL,PAR,M,MT,MYID,NPROCS
      USE MOD_RCA
# if defined (MULTIPROCESSOR)
      USE MOD_PAR
# endif
      IMPLICIT NONE
      SAVE
!      INCLUDE  'RCACM'
      CHARACTER(LEN=8)  :: GDNAMES(50)
      CHARACTER(LEN=3)  :: LYRDMP
      CHARACTER(LEN=80) :: COMMENT*80
      REAL   T(9000)
      INTEGER   IDMP(2,8)
      INTEGER IXY1,IXY2,IXY3,IXY4,IXY5,IXY6,IXY7,IXY8
      INTEGER IZ1,IZ2,IZ3,IZ4,IZ5,IZ6,IZ7,IZ8
      INTEGER INXY,INZ,INOSYS,NGDMP,I,J,LASTVAR,IVAR,LYR,IT
      REAL,ALLOCATABLE :: DUMP(:,:),TEMP(:,:)
      

      EQUIVALENCE                                         &
            (IDMP(1,1),IXY1) , (IDMP(2,1),IZ1)            &
          , (IDMP(1,2),IXY2) , (IDMP(2,2),IZ2)            &
          , (IDMP(1,3),IXY3) , (IDMP(2,3),IZ3)            &
          , (IDMP(1,4),IXY4) , (IDMP(2,4),IZ4)            &
          , (IDMP(1,5),IXY5) , (IDMP(2,5),IZ5)            &
          , (IDMP(1,6),IXY6) , (IDMP(2,6),IZ6)            &
          , (IDMP(1,7),IXY7) , (IDMP(2,7),IZ7)            &
          , (IDMP(1,8),IXY8) , (IDMP(2,8),IZ8)            
 
!     READ TIME RECORD (SKIPPING -SYSBY- HEADER RECORD)
      REWIND 10
      READ(10)  INXY,INZ,INOSYS,NGDMP
      READ(10)  (GDNAMES(I),I=1,NGDMP)
      READ(10)
      READ(10)
      DO 30 I=1,9000
   30 READ(10,END=40)  T(I)
   40 IF(I > 40 .AND. MSR)  WRITE(OUT,1100)
 1100 FORMAT(/////10X,'DUE TO DIMENSION LIMITS, THE FOLLOWING DUMPS WILL ',  &
            'BE LIMITED TO THE FIRST 40 TIME RECORDS'//)
      IREC=MIN(40,I-1)
      IF(IREC <= 16 .AND. MSR) WRITE(OUT,1110)
 1110 FORMAT('1') 
      LASTVAR=0

      READ(IN,'(A)') COMMENT

  100 READ(IN,1000,ERR=950,END=975) IVAR,((IDMP(J,I),J=1,2),I=1,8),LYRDMP,LYR 
 1000 FORMAT(25I3,A3,I3)
      IF(IVAR <= 0) GO TO 975
      IF(IVAR > NGDMP) GO TO 970
      IF(IVAR /= LASTVAR) THEN
!       PRODUCE A SYSTEM ONLY DUMP FILE FROM MASTER DUMP FILE 
        CALL RCABYSS (NGDMP,IVAR)
        LASTVAR=IVAR
      ENDIF

      IF(LYRDMP == 'LYR') THEN
        IF(MSR) WRITE(OUT,1200)  IVAR,GDNAMES(IVAR),LYR
 1200   FORMAT('1'//20X,'CONCS FOR SYSTEM',I3,' == ',A8,'  LAYER ',I3/)
        DO 110 IT=1,IREC
          IF((T(2)-T(1)) < 1.0 .AND. MSR) WRITE(OUT,3001) T(IT)
 3001     FORMAT(//5X,'TIME =',F6.3)
          IF((T(2)-T(1)) >= 1.0 .AND. MSR) WRITE(OUT,3002) T(IT)
 3002     FORMAT(//5X,'TIME =',F6.1)
          
	  IF(SERIAL) CALL RCAPRNT(SCRATCH_ARRAY(1,1,IT),LYR,LYR,MT)
# if defined (MULTIPROCESSOR)
       IF(PAR)THEN
        ALLOCATE(DUMP(NXY,NZ))   ;DUMP = 0.0
	ALLOCATE(TEMP(0:MT,NZ))  ;TEMP = 0.0
	TEMP(1:MT,1:NZ) = SCRATCH_ARRAY(1:MT,1:NZ,IT)
        CALL GATHER(LBOUND(TEMP,1),UBOUND(TEMP,1),M,NXY,NZ,     &
	            MYID,NPROCS,NMAP,TEMP,DUMP)
	CALL RCAPRNT(DUMP(1,1),LYR,LYR,MT)
	DEALLOCATE(DUMP,TEMP)
       END IF	
# endif

  110   CONTINUE

      ELSE
        IF(IXY1 == 0) GO TO 400
        IF(IREC > 16 .AND. MSR) WRITE(OUT,2200) IVAR,GDNAMES(IVAR)
 2200   FORMAT(/////20X,'CONCS FOR SYSTEM',I3,' == ',A8/)
        IF(IREC <= 16 .AND. MSR) WRITE(OUT,2201) IVAR,GDNAMES(IVAR)
 2201   FORMAT(/////20X,'CONCS FOR SYSTEM',I3,' == ',A8/)
        IF(MSR) WRITE(OUT,2500)  ((IDMP(J,I),J=1,2),I=1,8)
 2500   FORMAT(1X,//4X,'TIME',1X,8(1X,2I4)) 

        DO I=1,IREC 
         IF(SERIAL)THEN
          IF((T(2)-T(1)) < 1.0 .AND. MSR) WRITE(OUT,3000) T(I),        &
            SCRATCH_ARRAY(IXY1,IZ1,I),SCRATCH_ARRAY(IXY2,IZ2,I),       &
            SCRATCH_ARRAY(IXY3,IZ3,I),SCRATCH_ARRAY(IXY4,IZ4,I),       &
            SCRATCH_ARRAY(IXY5,IZ5,I),SCRATCH_ARRAY(IXY6,IZ6,I),       &
            SCRATCH_ARRAY(IXY7,IZ7,I),SCRATCH_ARRAY(IXY8,IZ8,I) 
 3000     FORMAT(1X,F8.5,8E13.4)
          IF((T(2)-T(1)) >= 1.0 .AND. MSR) WRITE(OUT,3010) T(I),       &
            SCRATCH_ARRAY(IXY1,IZ1,I),SCRATCH_ARRAY(IXY2,IZ2,I),      &
            SCRATCH_ARRAY(IXY3,IZ3,I),SCRATCH_ARRAY(IXY4,IZ4,I),      &
            SCRATCH_ARRAY(IXY5,IZ5,I),SCRATCH_ARRAY(IXY6,IZ6,I),      &
            SCRATCH_ARRAY(IXY7,IZ7,I),SCRATCH_ARRAY(IXY8,IZ8,I) 
 3010     FORMAT(1X,F8.1,8E13.4)
         END IF
	 
	 
# if defined (MULTIPROCESSOR)
         IF(PAR)THEN
          ALLOCATE(DUMP(NXY,NZ))   ;DUMP = 0.0
	  ALLOCATE(TEMP(0:MT,NZ))  ;TEMP = 0.0
	  TEMP(1:MT,1:NZ) = SCRATCH_ARRAY(1:MT,1:NZ,IT)
          CALL GATHER(LBOUND(TEMP,1),UBOUND(TEMP,1),M,NXY,NZ,     &
	            MYID,NPROCS,NMAP,TEMP,DUMP)
          IF((T(2)-T(1)) < 1.0 .AND. MSR) WRITE(OUT,3000) T(I),         &
           DUMP(IXY1,IZ1),DUMP(IXY2,IZ2),DUMP(IXY3,IZ3),DUMP(IXY4,IZ4), &
           DUMP(IXY5,IZ5),DUMP(IXY6,IZ6),DUMP(IXY7,IZ7),DUMP(IXY8,IZ8) 
          IF((T(2)-T(1)) >= 1.0 .AND. MSR) WRITE(OUT,3010) T(I),        &
           DUMP(IXY1,IZ1),DUMP(IXY2,IZ2),DUMP(IXY3,IZ3),DUMP(IXY4,IZ4), &
           DUMP(IXY5,IZ5),DUMP(IXY6,IZ6),DUMP(IXY7,IZ7),DUMP(IXY8,IZ8) 
	  DEALLOCATE(DUMP,TEMP)
         END IF	
# endif

        END DO

      ENDIF

      GO TO 100

  400 RETURN

  950 CALL FMTER
!JQI      CALL EXIT
      CALL PSTOP
  970 IF(MSR)WRITE(OUT,4500)  IVAR
 4500 FORMAT(//10X,'ILLEGAL VARIABLE NUMBER SPECIFIED FOR GLOBAL DUMPS'/    &
               10X,'IVAR = ',I3,5X,'RCA TERMINATED')

  975 RETURN
      END SUBROUTINE RCA12
